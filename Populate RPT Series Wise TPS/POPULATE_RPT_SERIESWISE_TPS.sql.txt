CREATE DEFINER=`root`@`127.0.0.1` PROCEDURE `POPULATE_RPT_SERIESWISE_TPS`()
BEGIN 
DECLARE MONTH_ID,mod_id,D_DAY,table_name VARCHAR(100);

DECLARE sub_table_name_1,sub_table_name_2 VARCHAR(100);

SELECT DATE_FORMAT(NOW() - INTERVAL 1 DAY,'%m') INTO MONTH_ID;

SELECT MOD(DATE_FORMAT(NOW() - INTERVAL 1 DAY,'%m'),4) into mod_id;

if ( mod_id = 0 )
 then set mod_id='04' ;
else set mod_id=concat("0",mod_id); 
end if;

SELECT DATE_FORMAT(NOW() - INTERVAL 1 DAY,'%d') INTO D_DAY;

set sub_table_name_1 = CONCAT("SUB_CDR_",D_DAY,"_00_12_",mod_id);

set sub_table_name_2 = CONCAT("SUB_CDR_",D_DAY,"_12_23_",mod_id);

select sub_table_name_1,sub_table_name_2;

SET @Q1=CONCAT("INSERT INTO RPT_SERIESWISE_TPS(RPT_DATE,LEVEL,LEVEL_CIRCLE_ID,OPERATOR_ID,CATEGORY,COUNT)
SELECT DATE(A.CREATE_TIME) DATE,A.LEVEL, A.LEVEL_CIRCLE_ID, A.OPERATOR_ID,CASE WHEN A.CNT BETWEEN 0 AND 15 THEN '0 to 15' WHEN A.CNT BETWEEN 16 AND 120 THEN '16 to 120' WHEN A.CNT BETWEEN 121 AND 240 THEN '121 to 240' WHEN A.CNT > 240 THEN 'greater than 240' END ÇATEGORY, SUM(CASE WHEN A.CNT BETWEEN 0 AND 15 THEN 1 WHEN A.CNT BETWEEN 16 AND 120 THEN 1  WHEN A.CNT BETWEEN 121 AND 240 THEN 1 WHEN A.CNT > 240 THEN 1  ELSE 0 END) COUNT FROM (SELECT CREATE_TIME,LEVEL, OPERATOR_ID, LEVEL_CIRCLE_ID , TIMESTAMPDIFF(SECOND,SUB.CREATE_TIME,SUB.FIELD5) CNT FROM ",sub_table_name_1," SUB WHERE SUB.STATUS_CODE=0 AND SUB.FIELD18='0' AND SUB.FIELD19='1')A GROUP BY ÇATEGORY,A.LEVEL,A.LEVEL_CIRCLE_ID, A.OPERATOR_ID");
PREPARE S1 FROM @Q1;
EXECUTE S1;
DEALLOCATE PREPARE S1;


SET @Q1=CONCAT("INSERT INTO RPT_SERIESWISE_TPS(RPT_DATE,LEVEL,LEVEL_CIRCLE_ID,OPERATOR_ID,CATEGORY,COUNT)
SELECT DATE(A.CREATE_TIME) DATE,A.LEVEL, A.LEVEL_CIRCLE_ID, A.OPERATOR_ID,CASE WHEN A.CNT BETWEEN 0 AND 15 THEN '0 to 15' WHEN A.CNT BETWEEN 16 AND 120 THEN '16 to 120' WHEN A.CNT BETWEEN 121 AND 240 THEN '121 to 240' WHEN A.CNT > 240 THEN 'greater than 240' END ÇATEGORY, SUM(CASE WHEN A.CNT BETWEEN 0 AND 15 THEN 1 WHEN A.CNT BETWEEN 16 AND 120 THEN 1  WHEN A.CNT BETWEEN 121 AND 240 THEN 1 WHEN A.CNT > 240 THEN 1  ELSE 0 END) COUNT FROM (SELECT CREATE_TIME,LEVEL, OPERATOR_ID, LEVEL_CIRCLE_ID , TIMESTAMPDIFF(SECOND,SUB.CREATE_TIME,SUB.FIELD5) CNT FROM ",sub_table_name_2," SUB WHERE SUB.STATUS_CODE=0 AND SUB.FIELD18='0' AND SUB.FIELD19='1')A GROUP BY ÇATEGORY,A.LEVEL,A.LEVEL_CIRCLE_ID, A.OPERATOR_ID");
PREPARE S1 FROM @Q1;
EXECUTE S1;
DEALLOCATE PREPARE S1;

END
