CREATE DEFINER=`cmsuser`@`127.0.0.1` PROCEDURE `Populate_RPT_SMSCACCOUNTWISE_FACT`(IN CDRDay int (20))
begin  select CDRDay; set @Query=concat("insert into RPT_SMSCACCOUNTWISE_FACT(CDR_DATE,DESCRIPTION,SMSC_ID,SMSC_USERNAME,SUBMIT_SUCCESS_COUNT,DELIVERY_RECEIVED_COUNT,DELIVERY_NOT_RECEIVED_COUNT,DELIVERY_SUCCESS_COUNT,DELIVERY_FAILURE_COUNT,SMSC_TPS,PEAK_TPS,ACCOUNT_TYPE) SELECT RSDF.CDR_DATE, SMSC.DESCRIPTION, SMSC.SMSC_ID, SMSC.SMSC_USERNAME, RSDF.SUBMIT_SUCCESS_COUNT, RSDF.DELIVERY_RECEIVED_COUNT, RSDF.DELIVERY_NOT_RECEIVED_COUNT, RSDF.DELIVERY_SUCCESS_COUNT, RSDF.DELIVERY_FAILURE_COUNT, SMSC.TOTAL_CONFIGURED_TPS, CASE WHEN SUBMIT_SUCCESS_COUNT < TOTAL_CONFIGURED_TPS THEN SUBMIT_SUCCESS_COUNT ELSE TOTAL_CONFIGURED_TPS END PEAK_TPS, SMSC.ACCOUNT_TYPE FROM (SELECT CDR_DATE, SMSC_ID, SUM(CASE WHEN STATUS_CODE = 0 THEN SUBMIT_COUNT ELSE 0 END) SUBMIT_SUCCESS_COUNT, SUM(CASE WHEN STATUS_CODE = 0 AND DEL_STATUS <> '-1' THEN DELIVERY_COUNT ELSE 0 END) DELIVERY_RECEIVED_COUNT, SUM(CASE WHEN STATUS_CODE = 0 AND DEL_STATUS = '-1' THEN DELIVERY_COUNT ELSE 0 END) DELIVERY_NOT_RECEIVED_COUNT, SUM(CASE WHEN (STATUS_CODE = 0  AND DEL_STATUS = '0') THEN DELIVERY_COUNT ELSE 0 END) DELIVERY_SUCCESS_COUNT, SUM(CASE WHEN (STATUS_CODE = 0 AND DEL_STATUS <> 0) THEN DELIVERY_COUNT ELSE 0 END) DELIVERY_FAILURE_COUNT FROM CMS_CDR.RPT_SUBMIT_DELIVERY_FACT_IB WHERE CDR_DATE = DATE(DATE_SUB(NOW(), INTERVAL ",CDRDay," DAY)) GROUP BY SMSC_ID) RSDF, CMS_CDR.SMSCTPS_ACCOUNTTYPE_DETAILS SMSC WHERE SMSC.SMSC_ID = RSDF.SMSC_ID;");    prepare s from @Query;  execute s;  deallocate prepare s;  end